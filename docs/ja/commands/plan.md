---
description: 要件を再記述し、リスクを評価し、ステップバイステップの実装計画を作成します。コードに触れる前にユーザーの確認を待ちます。
---

# Planコマンド

このコマンドは**planner**エージェントを呼び出し、コードを書く前に包括的な実装計画を作成します。

## このコマンドができること

1. **要件の再記述** - 構築すべきものを明確化
2. **リスクの特定** - 潜在的な問題とブロッカーを表面化
3. **ステップ計画の作成** - 実装をフェーズに分解
4. **確認を待つ** - 進行前にユーザーの承認を受ける必要がある

## 使用タイミング

以下の場合に`/plan`を使用：
- 新しい機能を開始する時
- 重要なアーキテクチャ変更を行う時
- 複雑なリファクタリングに取り組む時
- 複数のファイル/コンポーネントが影響を受ける時
- 要件が不明確または曖昧な時

## 動作方法

plannerエージェントは以下を実行：

1. **リクエストを分析**し、明確な言葉で要件を再記述
2. **フェーズに分解**、具体的で実行可能なステップで
3. **依存関係を特定**、コンポーネント間で
4. **リスクを評価**、潜在的なブロッカーを
5. **複雑さを見積もり**（High/Medium/Low）
6. **計画を提示**し、明示的な確認を待つ

## 使用例

```
ユーザー: /plan マーケットが解決された時にリアルタイム通知を追加する必要がある

エージェント（planner）:
# 実装計画：リアルタイムマーケット解決通知

## 要件の再記述
- ユーザーがウォッチしているマーケットが解決された時に通知を送信
- 複数の通知チャネルをサポート（アプリ内、メール、webhook）
- 通知が確実に配信されることを保証
- マーケットの結果とユーザーのポジション結果を含める

## 実装フェーズ

### フェーズ1：データベーススキーマ
- 通知テーブルを追加（列：id、user_id、market_id、type、status、created_at）
- ユーザー通知設定テーブルをチャネル設定用に追加
- パフォーマンスのためにuser_idとmarket_idにインデックスを作成

### フェーズ2：通知サービス
- lib/notifications.tsに通知サービスを作成
- BullMQ/Redisを使用して通知キューを実装
- 失敗した配信のためのリトライロジックを追加
- 通知テンプレートを作成

### フェーズ3：統合ポイント
- マーケット解決ロジックにフック（ステータスが"resolved"に変更された時）
- マーケット内のポジションを持つすべてのユーザーをクエリ
- 各ユーザーの通知をキューに追加

### フェーズ4：フロントエンドコンポーネント
- ヘッダーにNotificationBellコンポーネントを作成
- NotificationListモーダルを追加
- Supabaseサブスクリプション経由でリアルタイム更新を実装
- 通知設定ページを追加

## 依存関係
- Redis（キュー用）
- メールサービス（SendGrid/Resend）
- Supabaseリアルタイムサブスクリプション

## リスク
- HIGH: メール配信可能性（SPF/DKIMが必要）
- MEDIUM: マーケットあたり1000以上のユーザーでのパフォーマンス
- MEDIUM: マーケットが頻繁に解決される場合の通知スパム
- LOW: リアルタイムサブスクリプションのオーバーヘッド

## 推定複雑度: MEDIUM
- バックエンド: 4-6時間
- フロントエンド: 3-4時間
- テスト: 2-3時間
- 合計: 9-13時間

**確認待ち**: この計画で進めますか？（yes/no/modify）
```

## 重要な注意事項

**CRITICAL**: plannerエージェントは、"yes"または"proceed"または類似の肯定的な応答で計画を明示的に確認するまで、コードを書きません。

変更が必要な場合、以下のように応答：
- "modify: [あなたの変更]"
- "different approach: [代替案]"
- "skip phase 2 and do phase 3 first"

## 他のコマンドとの統合

計画後：
- `/tdd`でテスト駆動開発による実装
- ビルドエラーが発生した場合は`/build-and-fix`を使用
- 完成した実装をレビューするには`/code-review`を使用

## 関連エージェント

このコマンドは以下のエージェントを呼び出します：
`~/.claude/agents/planner.md`
